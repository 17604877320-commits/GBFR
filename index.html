<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBRFå› å­é…è£…å·¥å…·byç«‹å¤</title>
    <style>
        :root { --gold: #d4af37; --brown: #5d4037; --coffee: #eaddca; --bg: #fdfaf5; --green: #27ae60; --red: #e74c3c; --blue: #3498db; --purple: #9b59b6; }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--coffee); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; color: #333; }
        .main-layout { display: flex; gap: 15px; width: 100%; max-width: 1400px; align-items: flex-start; }
        
        .left-panel { flex: 1; position: sticky; top: 10px; display: flex; flex-direction: column; gap: 10px; min-width: 280px; }
        .target-box { background: var(--brown); color: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .target-header { border-bottom: 2px solid var(--gold); padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: var(--gold); font-size: 14px; }
        .target-item { display: flex; justify-content: space-between; padding: 5px 8px; font-size: 12px; margin-bottom: 3px; border-radius: 4px; background: rgba(255,255,255,0.08); align-items: center; }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-over { background-color: var(--red) !important; color: white !important; font-weight: bold; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
        .status-met { background-color: var(--green) !important; color: white !important; }

        .right-panel { flex: 2; background: var(--bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .ctrl-bar { background: #fff; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border: 1px solid #ddd; }
        .role-select { padding: 6px; border-radius: 4px; border: 1px solid var(--brown); font-weight: bold; color: var(--brown); font-size: 14px; }
        
        .input-section { display: flex; flex-direction: column; gap: 8px; }
        .slot-row { display: flex; gap: 8px; align-items: center; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
        .slot-label { font-size: 12px; font-weight: bold; color: #666; width: 50px; }
        select { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; background: #fff; }
        .lv-input { width: 45px; text-align: center; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }

        .btn-group { display: flex; gap: 8px; margin-top: 15px; }
        button { padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; color: #fff; cursor: pointer; font-size: 13px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: var(--green); flex: 1; }
        .btn-opt { background: var(--purple); flex: 2; }
        .btn-rand { background: var(--blue); flex: 1; }
        .btn-reset { background: var(--red); width: 80px; }
        
        .pool-section { width: 100%; max-width: 1400px; background: #fff; margin-top: 20px; padding: 15px; border-radius: 12px; border: 2px dashed var(--brown); box-sizing: border-box; }
        .pool-add-row { display: flex; gap: 8px; align-items: center; background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--blue); }
        .pool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; }
        .pool-item { background: #f9f9f9; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        footer { margin-top: 30px; font-size: 14px; color: var(--brown); font-weight: bold; opacity: 0.8; }
        
        @media (max-width: 800px) { .main-layout { flex-direction: column; } .left-panel { width: 100%; position: static; } }
    </style>
</head>
<body>

    <h2 style="margin:10px; color:var(--brown);">GBRFå› å­é…è£…å·¥å…·byç«‹å¤</h2>

    <div class="main-layout">
        <div class="left-panel">
            <div class="target-box">
                <div class="target-header">ğŸ’ æ­¦å™¨ç¥ç¦</div>
                <div id="blessTargetDisplay"></div>
            </div>
            <div class="target-box">
                <div class="target-header">ğŸ›¡ï¸ è§’è‰²å› å­ç›®æ ‡</div>
                <div id="factorTargetDisplay"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="ctrl-bar">
                <div>
                    è§’è‰²ï¼š<select id="roleSelector" class="role-select" onchange="switchRole()"></select>
                </div>
                <div>
                    <input type="checkbox" id="bahamutCheck" onchange="render()">
                    <label for="bahamutCheck" style="font-size:13px; font-weight:bold; cursor:pointer;">å·´æ­¦å…¨è§‰é†’ (+1)</label>
                </div>
            </div>

            <div style="background:var(--coffee); padding:10px; border-radius:8px; margin-bottom:10px;">
                <div style="font-size:12px; font-weight:bold; margin-bottom:5px; color:var(--brown);">ğŸ’ æ­¦å™¨ç¥ç¦</div>
                <div id="blessInputs" class="input-section"></div>
            </div>

            <div id="factorInputs" class="input-section"></div>

            <div class="btn-group">
                <button class="btn-opt" onclick="autoOptimize()">ğŸ§  æ™ºèƒ½é…è£… (å¸ä¸‹å› å­è‡ªåŠ¨å…¥åº“)</button>
                <button class="btn-rand" onclick="randomFill()">ğŸ² éšæœºå¡«å……æµ‹è¯•</button>
            </div>
            <div class="btn-group">
                <button class="btn-save" onclick="saveData()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ•°æ®</button>
                <button class="btn-reset" onclick="resetData()">ğŸ§¹ æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <div class="pool-section">
        <h3 style="margin:0 0 10px 0; color:var(--brown); font-size:16px;">ğŸ“¦ åº“å­˜å› å­ä»“åº“</h3>
        <div class="pool-add-row">
            <span style="font-weight:bold; color:var(--blue); font-size:12px;">å…¥åº“:</span>
            <select id="newMain"></select>
            <select id="newSub"></select>
            <input type="number" id="newLv" class="lv-input" value="15">
            <button class="btn-rand" style="width:60px; padding:6px;" onclick="addToPool()">æ·»åŠ </button>
        </div>
        <div class="pool-grid" id="poolGrid"></div>
    </div>

    <footer>Author: @ç«‹å¤</footer>

    <script>
        // --- 1. å…¨é‡æ•°æ® (æ•°æ®æ¸…æ´—å®Œæ¯•) ---
        const roleData = {
            "è‚‰è£…": { bless:{"è‡ªæ„ˆ":20,"å®ˆæŠ¤":15,"åšå®ˆ":10}, factors:["è‡ªåŠ¨è¯æ°´","è¯æ°´","å®ˆæŠ¤","å®ˆæŠ¤","å®ˆæŠ¤","è‡ªæ„ˆ","è‡ªæ„ˆ","è‡ªæ„ˆ","è‡ªåŠ¨å¤æ´»","ä½“åŠ›","åˆšå¥","åšå®ˆ","è±ªèƒ†","åŒ¿è¸ª","ä¸åŠ¨","é‡‘åˆš","é‡‘åˆš"] },
            "æ³½å¡”": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æ€’æ¶›":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¥‹ä¸é¡¾èº«","æ˜é•œæ­¢æ°´","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","çƒˆç„°","ç¿”èˆ","æˆ˜æ°”","è¿…æ·èƒ½åŠ›","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å¡çˆ·": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"å¥‹ä¸é¡¾èº«":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","èƒ½åŠ›ä¼¤å®³","æ˜é•œæ­¢æ°´","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","çœŸç†","è¿…æ·èƒ½åŠ›","æˆ˜æ°”","è¿…æ·èƒ½åŠ›","ç§˜çº¹Î²","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î²","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "é½æ ¼é£": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","æš´å‡»","æ˜é•œæ­¢æ°´","è¿…æ·èƒ½åŠ›","è±ªèƒ†","æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "è²è‰": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","è¿å‡»åŠ æˆ","æš´å‡»","èº²é¿è·ç¦»","æ˜é•œæ­¢æ°´","æˆ˜æ°”","è¿…æ·èƒ½åŠ›","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å§¬å¡”": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","æš´å‡»","æ˜é•œæ­¢æ°´","è‹±å‹‡ç¥é€Ÿ","æ€’æ¶›","è‹±å‹‡ä¹‹å¿ƒ","è¿…æ·èƒ½åŠ›","ç§˜çº¹Î²","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î²","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å¤æ´›ç‰¹": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","è¿å‡»åŠ æˆ","è‡ªåŠ¨å¤æ´»","å¼±ç‚¹æ”»å‡»","è¿å‡»æ”¶æ‹›","å¨å…‰","æš´å‡»","æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å¥¶åˆ€": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ˜é•œæ­¢æ°´","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¥‹ä¸é¡¾èº«","å¿«é€Ÿè“„åŠ›","è‡ªåŠ¨å¤æ´»","èƒ½åŠ›ä¼¤å®³","æš´å‡»","æ¢¦å¹»","æ­¦è‰º","æˆ˜æ°”","èº²é¿æ€§èƒ½","ä¼¤å®³ä¸Šé™","è¿…æ·èƒ½åŠ›","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "ä¼Šæ¬§": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"è“„åŠ›ä¼šå¿ƒ":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¿«é€Ÿè“„åŠ›","èº²é¿æ€§èƒ½","èº²é¿è·ç¦»","è‡ªåŠ¨å¤æ´»","å¿ƒæ„¿","ä¼¶ä¿","æˆ˜æ°”","æ€’æ¶›","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "ç´¢æ©": { bless:{"æ˜å¥":20,"åˆ€ä¸Šèˆ":15,"æ€’æ¶›":10}, factors:["äºŒç‹+","çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¿«é€Ÿè“„åŠ›","æš´å‡»","æš´å›","èº²é¿æ€§èƒ½","ä¸‡ç®­","å‡›å†½","æˆ˜æ°”","æ¿€æ˜‚","éšåŒ¿","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "ä¼Šå¾·": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æš´å‡»","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","æš´å‡»","è±ªèƒ†","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","å¼‚èƒ½æˆ˜æ„","å¼‚èƒ½å¢é•¿","å¼‚èƒ½ä¹‹å¿ƒ","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "è€ä¸ƒ": { bless:{"æ˜å¥":20,"è¯æ°´":15,"æ€’æ¶›":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","æ˜é•œæ­¢æ°´","è¿½å‡»","è¿½å‡»","è¿å‡»åŠ æˆ","æš´å›","ä¸ƒæ˜Ÿ+","èº²é¿æ€§èƒ½","è‡ªåŠ¨å¤æ´»","é—ªåˆƒ","æš´å‡»","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å¡å§": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","æš´å‡»","å¼±ç‚¹æ”»å‡»","èƒ½åŠ›ä¼¤å®³","è‡ªåŠ¨å¤æ´»","å†³å¿ƒ","éª„å‚²","å¥‹ä¸é¡¾èº«","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "ç‚å¸": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","æš´å‡»","å¥‹ä¸é¡¾èº«","æ€’æ¶›","å¿«é€Ÿè“„åŠ›","è‡ªåŠ¨å¤æ´»","ç‹è€…è¿›è¡Œ","èº²é¿æ€§èƒ½","ç‹è€…æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "èèµ›å¡”": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","è¿½å‡»","è±ªèƒ†","è‡ªåŠ¨å¤æ´»","æš´å‡»","è¿…æ·èƒ½åŠ›","æš´å‡»","è‡ªåŠ¨å¤æ´»","ç«ç‘°æ—©ç»½","èº²é¿æ€§èƒ½","ç«ç‘°æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å…°æ–¯": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","æ‘‡æ›³æ­¥","è¯æ°´","è¿½å‡»","è¿½å‡»","æš´å‡»","è‡ªåŠ¨å¤æ´»","è¿å‡»åŠ æˆ","è¿…æ·èƒ½åŠ›","åˆ€ä¸Šèˆ","è¿…æ·èƒ½åŠ›","ç™½é¾™æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "æ°´è€å¤´": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","æš´å‡»","è‡ªåŠ¨å¤æ´»","æš´å‡»","è¿…æ·èƒ½åŠ›","èƒ½åŠ›ä¼¤å®³","æ€’æ¶›","å¦–å‰‘å£«","èº²é¿æ€§èƒ½","æˆ˜æ°”","æ˜é•œæ­¢æ°´","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "åœ£å¾·èŠ¬": { bless:{"æ˜å¥":20,"æš´å‡»":15,"è‡ªåŠ¨å¤æ´»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","è¿å‡»åŠ æˆ","æš´å›","åˆ€ä¸Šèˆ","é›†ä¸­ç‚®ç«","å¥‹ä¸é¡¾èº«","æš´å‡»ä¼¤å®³","æ— æ€+","æˆ˜æ°”","æ˜é•œæ­¢æ°´","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","æ ¼æŒ¡","éšåŒ¿","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å·´å”": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"è“„åŠ›ä¼šå¿ƒ":10}, factors:["èƒŒæ°´","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¥‹ä¸é¡¾èº«","è“„åŠ›æ”»å‡»","å¿«é€Ÿè“„åŠ›","æš´å‡»ä¼¤å®³","å¹½å†¥è‡ªè‹¥","æ˜é•œæ­¢æ°´","æˆ˜æ°”","èº²é¿æ€§èƒ½","ä¼¤å®³ä¸Šé™","è±ªèƒ†","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "æ¬§æ ¹": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¿«é€Ÿè“„åŠ›","å¿«é€Ÿè“„åŠ›","é›†ä¸­ç‚®ç«","åˆ€ä¸Šèˆ","å¤©çœ¼","æ˜é•œæ­¢æ°´","æˆ˜æ°”","èº²é¿æ€§èƒ½","ç§˜çº¹Î²","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "å·´æ©": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","æ¿€æ˜‚","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","è¿å‡»åŠ æˆ","è¿å‡»æ”¶æ‹›","å¼±ç‚¹æ”»å‡»","å¥‹ä¸é¡¾èº«","æš´å‡»ä¼¤å®³","æ¯…åŠ›","æš´å‡»","æˆ˜æ°”","èº²é¿æ€§èƒ½","ä¼¤å®³ä¸Šé™","è‡ªåŠ¨å¤æ´»","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "æ‹‰å¡å§†": { bless:{"æ˜å¥":20,"è¿½å‡»":15,"æš´å‡»":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¿«é€Ÿè“„åŠ›","æ˜é•œæ­¢æ°´","æš´å‡»","éšåŒ¿","æ¿€æ˜‚","æŒ‡å¼•","åšæŒ","æˆ˜æ°”","èº²é¿æ€§èƒ½","ä¼¤å®³ä¸Šé™","è‡ªåŠ¨å¤æ´»","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] },
            "ç‰›çˆ·çˆ·": { bless:{"å¼±ç‚¹æ”»å‡»":20,"è¿½å‡»":15,"è“„åŠ›ä¼šå¿ƒ":10}, factors:["çƒ­è¡€","æš´å›","å±è½¬","è¿…æ·èƒ½åŠ›","ç‹‚æˆ˜å£«","è¯æ°´","è¿½å‡»","è¿½å‡»","å¥‹ä¸é¡¾èº«","è“„åŠ›æ”»å‡»","æš´å‡»ä¼¤å®³","è‡ªåŠ¨å¤æ´»","å¼ºè€…","æ˜é•œæ­¢æ°´","æˆ˜æ°”","èº²é¿æ€§èƒ½","ç§˜çº¹Î±","æ˜å¥","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î±","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™","ç§˜çº¹Î³","ä¼¤å®³ä¸Šé™"] }
        };

        // --- 2. å±æ€§æ’åº (æŒ‰å…¨è§’è‰²é¢‘ç‡) ---
        const allFactorAttrs = Object.values(roleData).flatMap(r => r.factors);
        const freqMap = {}; 
        allFactorAttrs.forEach(a => freqMap[a] = (freqMap[a] || 0) + 1);
        const sortedAttrs = Object.keys(freqMap).sort((a,b) => freqMap[b] - freqMap[a]);
        // é€‰é¡¹æ± ï¼šé¢‘ç‡æ’åº + ç‰¹æ®Šè¯æ¡
        const finalPool = ["ç©ºç¼º", ...sortedAttrs, "è±ªèƒ†", "å›é¿è·ç¦»", "å›é¿æ€§èƒ½", "è‡ªåŠ¨è¯æ°´", "å®ˆæŠ¤", "è‡ªæ„ˆ", "ä½“åŠ›", "åˆšå¥", "åšå®ˆ", "åŒ¿è¸ª", "ä¸åŠ¨", "åšæŒ", "é‡‘åˆš"];

        // --- 3. çŠ¶æ€ç®¡ç† ---
        let currentRole = "æ³½å¡”";
        let blessData = JSON.parse(localStorage.getItem('gbfr_bless_v13')) || Array(3).fill(null).map(() => ({attr: "ç©ºç¼º", lv: 0}));
        let factorData = JSON.parse(localStorage.getItem('gbfr_factor_v13')) || Array(12).fill(null).map(() => ({main: "ç©ºç¼º", sub: "ç©ºç¼º", lv: 15}));
        let poolData = JSON.parse(localStorage.getItem('gbfr_pool_v13')) || [];

        function init() {
            const sel = document.getElementById('roleSelector');
            Object.keys(roleData).forEach(k => sel.options.add(new Option(k, k)));
            
            const fillOpts = (domId) => {
                const dom = document.getElementById(domId);
                dom.innerHTML = "";
                finalPool.forEach(a => dom.options.add(new Option(a, a)));
            };
            fillOpts('newMain'); fillOpts('newSub');
            render();
        }

        function switchRole() { currentRole = document.getElementById('roleSelector').value; render(); }

        function render() {
            const isBahamut = document.getElementById('bahamutCheck').checked;
            const config = roleData[currentRole];
            
            // 1. ç»Ÿè®¡æ€»ç­‰çº§ (å› å­+ç¥ç¦)
            const stats = {};
            // å› å­ç»Ÿè®¡
            factorData.forEach(d => {
                if(d.main !== "ç©ºç¼º") stats[d.main] = (stats[d.main] || 0) + d.lv;
                if(d.sub !== "ç©ºç¼º" && d.sub !== "å›ºå®š(N/A)") stats[d.sub] = (stats[d.sub] || 0) + d.lv;
            });
            // ç¥ç¦ç»Ÿè®¡
            blessData.forEach(d => { if(d.attr !== "ç©ºç¼º") stats[d.attr] = (stats[d.attr] || 0) + d.lv; });

            // 2. æ¸²æŸ“ç¥ç¦ (äº«å—å·´æ­¦)
            document.getElementById('blessTargetDisplay').innerHTML = Object.keys(config.bless).map(a => {
                const bBase = blessData.reduce((acc, c) => c.attr === a ? acc + c.lv : acc, 0);
                const bTotal = bBase + (isBahamut && bBase > 0 ? 1 : 0);
                const target = config.bless[a];
                return `<div class="target-item ${bTotal>=target?'status-met':''}"><span>${a}</span><span>${bTotal}/${target}</span></div>`;
            }).join('');

            // 3. æ¸²æŸ“å› å­ (äº«å—å·´æ­¦)
            const fT = {}; config.factors.forEach(f => fT[f] = (fT[f] || 0) + 15);
            document.getElementById('factorTargetDisplay').innerHTML = Object.keys(fT).map(attr => {
                const baseLv = stats[attr] || 0;
                const finalLv = baseLv + (isBahamut && baseLv > 0 ? 1 : 0);
                const target = fT[attr];
                
                let cls = "";
                if (baseLv > target) cls = "status-over"; // åŸºç¡€å°±è¶…æ ‡ -> çº¢
                else if (finalLv >= target) cls = "status-met"; // æœ€ç»ˆè¾¾æ ‡ -> ç»¿

                return `<div class="target-item ${cls}"><span>${attr}</span><span>${finalLv}/${target}</span></div>`;
            }).join('');

            // 4. æ¸²æŸ“å› å­å½•å…¥åŒº (å¤„ç†+å·é”å®š)
            const currentRolePool = ["ç©ºç¼º", ...new Set([...config.factors, ...Object.keys(config.bless)])];
            
            const drawSelects = (container, data, isBless) => {
                document.getElementById(container).innerHTML = data.map((d, i) => {
                    // æ£€æŸ¥ä¸»å±æ€§æ˜¯å¦å¸¦ +
                    const isPlusMain = !isBless && (d.main.endsWith("+") || ["äºŒç‹+","ä¸ƒæ˜Ÿ+","ä¸“å±+"].includes(d.main));
                    
                    return `
                    <div class="slot-row">
                        <span class="slot-label">${isBless?'ç¥ç¦'+(i+1):'æ§½ä½'+(i+1)}</span>
                        <select onchange="upd('${isBless?'bless':'factor'}', ${i}, '${isBless?'attr':'main'}', this.value)">
                            ${currentRolePool.map(a => `<option value="${a}" ${(isBless?d.attr:d.main)===a?'selected':''}>${a}</option>`).join('')}
                            ${!currentRolePool.includes(isBless?d.attr:d.main) ? `<option value="${isBless?d.attr:d.main}" selected>${isBless?d.attr:d.main}</option>` : ''}
                        </select>
                        ${!isBless?`<select ${isPlusMain?'disabled style="background:#eee"':''} onchange="upd('factor', ${i}, 'sub', this.value)">
                            ${isPlusMain ? `<option>å›ºå®š(N/A)</option>` : ''}
                            ${currentRolePool.map(a => `<option value="${a}" ${!isPlusMain && d.sub===a?'selected':''}>${a}</option>`).join('')}
                            ${!isPlusMain && !currentRolePool.includes(d.sub) ? `<option value="${d.sub}" selected>${d.sub}</option>` : ''}
                        </select>`:''}
                        <input type="number" class="lv-input" value="${d.lv}" oninput="upd('${isBless?'bless':'factor'}', ${i}, 'lv', parseInt(this.value)||0)">
                    </div>`
                }).join('');
            };
            drawSelects('blessInputs', blessData, true);
            drawSelects('factorInputs', factorData, false);

            document.getElementById('poolGrid').innerHTML = poolData.map((s, i) => `
                <div class="pool-item">
                    <span><strong>${s.m}+${s.s}</strong> <span style="color:#666">(Lv.${s.l})</span></span>
                    <button onclick="delPool(${i})" style="background:none; color:var(--red); padding:0; width:auto; font-size:16px;">Ã—</button>
                </div>`).join('');
        }

        function upd(t, i, f, v) { 
            if(t==='bless') blessData[i][f]=v; 
            else {
                factorData[i][f]=v;
                // å¦‚æœé€‰äº†+å·å› å­ï¼Œå¼ºåˆ¶å‰¯å±æ€§ä¸ºç©º
                if(f === 'main' && (v.endsWith("+") || ["äºŒç‹+","ä¸ƒæ˜Ÿ+","ä¸“å±+"].includes(v))) {
                    factorData[i].sub = "å›ºå®š(N/A)";
                }
            }
            render(); 
        }
        function saveData() { 
            localStorage.setItem('gbfr_bless_v13', JSON.stringify(blessData)); 
            localStorage.setItem('gbfr_factor_v13', JSON.stringify(factorData)); 
            localStorage.setItem('gbfr_pool_v13', JSON.stringify(poolData)); 
            alert("ç«‹å¤ï¼šæ•°æ®ä¿å­˜æˆåŠŸï¼"); 
        }
        function addToPool() {
            const m = document.getElementById('newMain').value, s = document.getElementById('newSub').value, l = parseInt(document.getElementById('newLv').value);
            if(m!=="ç©ºç¼º") { poolData.push({m, s, l}); render(); }
        }
        function delPool(i) { poolData.splice(i, 1); render(); }
        function resetData() { if(confirm("æ¸…ç©ºï¼Ÿ")) { blessData=Array(3).fill(null).map(()=>({attr:"ç©ºç¼º",lv:0})); factorData=Array(12).fill(null).map(()=>({main:"ç©ºç¼º",sub:"ç©ºç¼º",lv:15})); render(); } }
        function randomFill() {
            const config = roleData[currentRole];
            const targetSet = [...config.factors];
            factorData = factorData.map(() => {
                const getMain = () => Math.random() < 0.7 ? targetSet[Math.floor(Math.random()*targetSet.length)] : finalPool[Math.floor(Math.random()*finalPool.length)];
                const getSub = () => Math.random() < 0.7 ? targetSet[Math.floor(Math.random()*targetSet.length)] : finalPool[Math.floor(Math.random()*finalPool.length)];
                return { main: getMain(), sub: getSub(), lv: 15 };
            });
            render();
        }

        function autoOptimize() {
            const config = roleData[currentRole];
            const targetNeeds = {};
            config.factors.forEach(f => targetNeeds[f] = (targetNeeds[f] || 0) + 15);
            
            // å·²æœ‰åŸºç¡€ (ä»…è®¡ç®—ç¥ç¦)
            let currentFill = {};
            Object.keys(targetNeeds).forEach(k => {
                const bLv = blessData.reduce((acc, c) => c.attr === k ? acc + c.lv : acc, 0);
                currentFill[k] = bLv; // ç¥ç¦ä¸äº«å—å·´æ­¦è®¡ç®—åœ¨é…è£…é˜¶æ®µï¼Œåªè®¡ç®—åŸºç¡€å€¼
            });

            const activeItems = factorData.filter(d => d.main !== "ç©ºç¼º").map(d => ({m: d.main, s: d.sub, l: d.lv}));
            let candidates = [...activeItems, ...poolData];
            // å»é‡é€»è¾‘ï¼šå¦‚æœéœ€è¦ï¼Œå¯æ·»åŠ å”¯ä¸€IDï¼Œæ­¤å¤„ç®€å•åˆå¹¶
            const newLoadout = [];
            
            // è´ªå¿ƒç®—æ³•
            for (let i = 0; i < 12; i++) {
                if (candidates.length === 0) {
                    newLoadout.push({main: "ç©ºç¼º", sub: "ç©ºç¼º", lv: 15});
                    continue;
                }
                candidates.forEach(cand => {
                    let score = 0;
                    const mNeed = (targetNeeds[cand.m] || 0) - (currentFill[cand.m] || 0);
                    if (mNeed > 0) score += 10;
                    
                    if (cand.s !== "å›ºå®š(N/A)") {
                        const sNeed = (targetNeeds[cand.s] || 0) - (currentFill[cand.s] || 0);
                        if (sNeed > 0) score += 10;
                        if (mNeed > 0 && sNeed > 0) score += 5;
                    }
                    cand._score = score;
                });
                candidates.sort((a, b) => b._score - a._score);
                const best = candidates[0];
                if (best._score > 0) {
                    newLoadout.push({ main: best.m, sub: best.s, lv: best.l });
                    currentFill[best.m] = (currentFill[best.m] || 0) + best.l;
                    if(best.s !== "å›ºå®š(N/A)") currentFill[best.s] = (currentFill[best.s] || 0) + best.l;
                    candidates.shift(); 
                } else {
                    newLoadout.push({main: "ç©ºç¼º", sub: "ç©ºç¼º", lv: 15});
                }
            }
            factorData = newLoadout;
            poolData = candidates; 
            alert(`ã€${currentRole}ã€‘æ™ºèƒ½é…è£…å®Œæˆï¼\nå‰©ä½™å› å­å·²è‡ªåŠ¨å…¥åº“ã€‚`);
            render();
        }
        init();
    </script>
</body>
</html>
